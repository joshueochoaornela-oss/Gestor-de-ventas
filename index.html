<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Ventas y Finanzas de Vitor</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .tab-button.active {
            border-bottom-width: 3px;
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            font-weight: 600;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen bg-gray-50 flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">Control de Negocio | Vitor</h1>
            <div class="text-xs text-gray-500 rounded-full bg-gray-100 px-3 py-1 truncate" id="userIdDisplay">Cargando...</div>
        </div>
        <!-- Tabs -->
        <nav class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 flex space-x-4 border-b border-gray-200">
            <button class="tab-button py-3 px-2 text-sm text-gray-600 hover:text-blue-500 active" data-tab="vendedores">Vendedores</button>
            <button class="tab-button py-3 px-2 text-sm text-gray-600 hover:text-blue-500" data-tab="pos">Puntos de Venta</button>
            <button class="tab-button py-3 px-2 text-sm text-gray-600 hover:text-blue-500" data-tab="gastos">Gastos</button>
            <button class="tab-button py-3 px-2 text-sm text-gray-600 hover:text-blue-500" data-tab="resumen">Resumen</button>
            <button class="tab-button py-3 px-2 text-sm text-gray-600 hover:text-blue-500" data-tab="config">Configuración</button>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow max-w-4xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6">
        <div id="content-container">
            <!-- Content will be injected here -->
        </div>
    </main>

    <!-- Custom Modal for Alerts/Confirmation -->
    <div id="custom-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform scale-95 transition-all">
            <h3 class="text-lg font-semibold text-gray-900 mb-4" id="modal-title">Atención</h3>
            <p class="text-sm text-gray-600 mb-6" id="modal-message"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300 transition">Cancelar</button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-100 bg-opacity-70 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
            <p class="mt-4 text-gray-600">Cargando datos...</p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, deleteDoc, addDoc, Timestamp, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Variables Globales ---
    const TABS = { VENDEDORES: 'vendedores', POS: 'pos', GASTOS: 'gastos', RESUMEN: 'resumen', CONFIG: 'config' };
    let currentTab = TABS.VENDEDORES;
    let vendedores = [];
    let puntosDeVenta = [];
    let movimientosPOS = [];
    let gastos = [];
    let precioUnidad = 10;
    let userId = null;
    let db, auth;
    let isAuthReady = false;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- DOM Elements ---
    const contentContainer = document.getElementById('content-container');
    const tabButtons = document.querySelectorAll('.tab-button');
    const loadingOverlay = document.getElementById('loading-overlay');
    const userIdDisplay = document.getElementById('userIdDisplay');

    // --- Firebase Initialization and Auth ---

    if (firebaseConfig) {
        setLogLevel('debug'); // Enable Firestore logging
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        const setupAuth = async () => {
            try {
                await setPersistence(auth, browserSessionPersistence);
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }
        };

        onAuthStateChanged(auth, (user) => {
            userId = user ? user.uid : 'Anonimo-' + crypto.randomUUID();
            userIdDisplay.textContent = `ID Usuario: ${userId.substring(0, 10)}...`;
            isAuthReady = true;
            hideLoading();
            renderTab(currentTab); // Initial render once auth is ready
            setupFirestoreListeners();
        });

        setupAuth();
    } else {
        console.error("Firebase config not available. Running in mock mode.");
        userIdDisplay.textContent = 'Modo Simulación';
        isAuthReady = true;
        hideLoading();
        renderTab(currentTab);
    }

    // --- Utility Functions ---

    function showLoading() { loadingOverlay.classList.remove('opacity-0', 'pointer-events-none'); }
    function hideLoading() { loadingOverlay.classList.add('opacity-0', 'pointer-events-none'); }

    /**
     * @param {string} tabName
     */
    function renderTab(tabName) {
        currentTab = tabName;

        tabButtons.forEach(button => {
            button.classList.remove('active');
            if (button.dataset.tab === tabName) {
                button.classList.add('active');
            }
        });

        // Use a switch for tab content generation
        switch (tabName) {
            case TABS.VENDEDORES:
                renderVendedores();
                break;
            case TABS.POS:
                renderPuntosDeVenta();
                break;
            case TABS.GASTOS:
                renderGastos();
                break;
            case TABS.RESUMEN:
                renderResumen();
                break;
            case TABS.CONFIG:
                renderConfiguracion();
                break;
        }
    }

    // --- Firebase Path & Listener Setup ---

    /**
     * @param {string} collectionName
     * @returns {string}
     */
    const getCollectionPath = (collectionName) => {
        if (!userId) return '';
        // Private data path
        return `artifacts/${appId}/users/${userId}/${collectionName}`;
    };

    function setupFirestoreListeners() {
        if (!isAuthReady || !db) return;

        // Vendedores Listener
        onSnapshot(collection(db, getCollectionPath('vendedores')), (snapshot) => {
            vendedores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            vendedores.sort((a, b) => (a.nombre > b.nombre) ? 1 : -1);
            if (currentTab === TABS.VENDEDORES) renderVendedores();
            if (currentTab === TABS.RESUMEN) renderResumen();
        }, (error) => console.error("Error al escuchar Vendedores:", error));

        // Puntos de Venta (Entities) Listener
        onSnapshot(collection(db, getCollectionPath('puntos_de_venta')), (snapshot) => {
            puntosDeVenta = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            puntosDeVenta.sort((a, b) => (a.nombre > b.nombre) ? 1 : -1);
            if (currentTab === TABS.POS) renderPuntosDeVenta();
        }, (error) => console.error("Error al escuchar Puntos de Venta:", error));

        // Movimientos POS Listener
        onSnapshot(query(collection(db, getCollectionPath('movimientos_pos'))), (snapshot) => {
            movimientosPOS = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            movimientosPOS.sort((a, b) => b.fecha_envio.toMillis() - a.fecha_envio.toMillis());
            if (currentTab === TABS.POS) renderPuntosDeVenta();
            if (currentTab === TABS.RESUMEN) renderResumen();
        }, (error) => console.error("Error al escuchar Movimientos POS:", error));

        // Gastos Listener
        onSnapshot(collection(db, getCollectionPath('gastos')), (snapshot) => {
            gastos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            gastos.sort((a, b) => b.fecha.toMillis() - a.fecha.toMillis());
            if (currentTab === TABS.GASTOS) renderGastos();
            if (currentTab === TABS.RESUMEN) renderResumen();
        }, (error) => console.error("Error al escuchar Gastos:", error));

        // Config Listener (to track precioUnidad)
        onSnapshot(doc(db, getCollectionPath('config'), 'global'), (docSnapshot) => {
            if (docSnapshot.exists()) {
                const data = docSnapshot.data();
                precioUnidad = data.precioUnidad || 10;
            } else {
                // Initialize default config if not found
                setDoc(doc(db, getCollectionPath('config'), 'global'), { precioUnidad: 10 }).catch(e => console.error("Error setting default config:", e));
            }
            if (currentTab === TABS.CONFIG) renderConfiguracion();
            if (currentTab === TABS.VENDEDORES) renderVendedores();
            if (currentTab === TABS.RESUMEN) renderResumen(); 
        }, (error) => console.error("Error al escuchar Config:", error));
    }

    // --- Modal Implementation ---

    /**
     * @param {string} title
     * @param {string} message
     * @param {function(): void} onConfirm
     * @param {boolean} isConfirm
     */
    function showModal(title, message, onConfirm, isConfirm = true) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').textContent = message;
        
        const modal = document.getElementById('custom-modal');
        const confirmBtn = document.getElementById('modal-confirm');
        const cancelBtn = document.getElementById('modal-cancel');

        confirmBtn.onclick = () => {
            modal.classList.add('opacity-0', 'pointer-events-none');
            onConfirm();
        };

        cancelBtn.onclick = () => {
            modal.classList.add('opacity-0', 'pointer-events-none');
        };
        
        cancelBtn.classList.toggle('hidden', !isConfirm);
        confirmBtn.classList.toggle('bg-red-600', isConfirm);
        confirmBtn.classList.toggle('hover:bg-red-700', isConfirm);
        confirmBtn.textContent = isConfirm ? 'Confirmar' : 'Entendido';

        modal.classList.remove('opacity-0', 'pointer-events-none');
    }

    // --- VENDEDORES (Salesperson) Logic and Rendering ---

    /**
     * @param {string} name
     */
    async function addVendedor(name) {
        if (!db || !isAuthReady) return;
        try {
            showLoading();
            await addDoc(collection(db, getCollectionPath('vendedores')), {
                nombre: name,
                entregado_qty: 0,
                vendido_qty: 0,
                pagado: 0,
            });
            hideLoading();
        } catch (e) {
            console.error("Error adding vendedor:", e);
            hideLoading();
            showModal("Error", "No se pudo agregar el vendedor.", () => {}, false);
        }
    }

    /**
     * @param {string} id
     * @param {'ENTREGA'|'VENTA'|'PAGO'} type
     * @param {number} amount
     */
    async function updateVendedor(id, type, amount) {
        if (!db || !isAuthReady) return;
        const vendRef = doc(db, getCollectionPath('vendedores'), id);
        
        try {
            await runTransaction(db, async (transaction) => {
                const vendDoc = await transaction.get(vendRef);
                if (!vendDoc.exists()) {
                    throw new Error("Vendedor no existe!");
                }
                
                const data = vendDoc.data();
                const updates = {};

                if (type === 'ENTREGA') {
                    // ENTREGA: Add to inventory delivered
                    updates.entregado_qty = (data.entregado_qty || 0) + amount;
                } else if (type === 'VENTA') {
                    // VENTA: Add to quantity sold (creates a debt)
                    const currentStock = (data.entregado_qty || 0) - (data.vendido_qty || 0);
                    if (amount > currentStock) {
                         throw new Error(`La cantidad vendida (${amount}) excede el stock pendiente (${currentStock}). Venta no registrada.`);
                    }
                    updates.vendido_qty = (data.vendido_qty || 0) + amount;
                } else if (type === 'PAGO') {
                    // PAGO: Add to amount paid (reduces pending debt)
                    const stats = calculateVendedorStats(data);
                    if (amount > stats.pendiente_de_pago + 0.01) { // Adding small tolerance
                         throw new Error(`El pago de $${amount.toFixed(2)} excede la deuda pendiente de $${stats.pendiente_de_pago.toFixed(2)}.`);
                    }
                    updates.pagado = (data.pagado || 0) + amount;
                }

                transaction.update(vendRef, updates);
            });
        } catch (e) {
            console.error("Error updating vendedor:", e);
            showModal("Error de Transacción", e.message || "Ocurrió un error al actualizar al vendedor.", () => {}, false);
        }
    }

    function calculateVendedorStats(v) {
        const stock_pendiente_qty = (v.entregado_qty || 0) - (v.vendido_qty || 0);
        // Total debt is calculated on the QUANTITY SOLD
        const deuda_total = (v.vendido_qty || 0) * precioUnidad;
        const pendiente_de_pago = deuda_total - (v.pagado || 0);
        
        return { stock_pendiente_qty, deuda_total, pendiente_de_pago };
    }

    function renderVendedores() {
        const html = `
            <div class="space-y-6">
                <div class="card bg-white p-4 rounded-xl">
                    <h2 class="text-xl font-semibold mb-3 text-gray-800">Agregar Vendedor</h2>
                    <div class="flex space-x-2">
                        <input type="text" id="newVendedorName" placeholder="Nombre del Vendedor" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <button id="addVendedorBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 text-sm">
                            Agregar
                        </button>
                    </div>
                </div>

                <div class="space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800">Lista de Vendedores (${vendedores.length})</h2>
                    ${vendedores.length === 0 ? '<p class="text-gray-500">No hay vendedores registrados.</p>' : ''}
                    ${vendedores.map(v => {
                        const stats = calculateVendedorStats(v);
                        const isStockLow = stats.stock_pendiente_qty < 5 && stats.stock_pendiente_qty > 0;
                        const isStockEmpty = stats.stock_pendiente_qty <= 0;
                        const isDebtPending = stats.pendiente_de_pago > 0.01;
                        
                        return `
                            <div class="card bg-white p-4 rounded-xl border ${isDebtPending ? 'border-red-300' : 'border-gray-200'}">
                                <h3 class="text-lg font-bold text-gray-900 mb-2">${v.nombre}</h3>
                                <div class="grid grid-cols-2 gap-2 text-sm text-gray-700 mb-4">
                                    <p class="font-medium">Entregado (Qty): <span class="font-bold text-green-600">${v.entregado_qty.toFixed(0)}</span></p>
                                    <p class="font-medium">Vendido (Qty): <span class="font-bold text-blue-600">${v.vendido_qty.toFixed(0)}</span></p>
                                    <p class="font-medium">Stock Pendiente (Qty): 
                                        <span class="font-bold ${isStockEmpty ? 'text-gray-500' : isStockLow ? 'text-orange-500' : 'text-yellow-600'}">
                                            ${stats.stock_pendiente_qty.toFixed(0)}
                                        </span>
                                        ${isStockEmpty ? '<span class="text-xs text-red-500 ml-1">(Sin Stock)</span>' : ''}
                                    </p>
                                    <p class="font-medium">Deuda Total (Calculada): <span class="font-bold text-red-600">$${stats.deuda_total.toFixed(2)}</span></p>
                                    <p class="font-medium col-span-2">Pagado: <span class="font-bold text-green-600">$${(v.pagado || 0).toFixed(2)}</span></p>
                                    <p class="font-medium col-span-2">
                                        CANTIDAD FALTANTE (PENDIENTE DE PAGO): 
                                        <span class="font-extrabold ${isDebtPending ? 'text-red-700' : 'text-green-700'} text-lg">$${Math.max(0, stats.pendiente_de_pago).toFixed(2)}</span>
                                    </p>
                                </div>

                                <div class="space-y-3 pt-4 border-t border-gray-100">
                                    <div class="flex space-x-2">
                                        <input type="number" id="qty-entrega-${v.id}" placeholder="Qty a Entregar" class="flex-grow p-2 border border-blue-300 rounded-lg text-sm">
                                        <button data-id="${v.id}" data-type="ENTREGA" class="action-btn bg-blue-100 text-blue-800 font-medium py-2 px-3 rounded-lg text-xs hover:bg-blue-200">Entregar</button>
                                    </div>
                                    <div class="flex space-x-2">
                                        <input type="number" id="qty-venta-${v.id}" placeholder="Qty Vendida" class="flex-grow p-2 border border-blue-300 rounded-lg text-sm">
                                        <button data-id="${v.id}" data-type="VENTA" class="action-btn bg-yellow-100 text-yellow-800 font-medium py-2 px-3 rounded-lg text-xs hover:bg-yellow-200">Registrar Venta</button>
                                    </div>
                                    <div class="flex space-x-2">
                                        <input type="number" id="monto-pago-${v.id}" placeholder="Monto del Pago Parcial" class="flex-grow p-2 border border-green-300 rounded-lg text-sm">
                                        <button data-id="${v.id}" data-type="PAGO" class="action-btn bg-green-100 text-green-800 font-medium py-2 px-3 rounded-lg text-xs hover:bg-green-200">Registrar Pago</button>
                                    </div>
                                    <button data-id="${v.id}" class="delete-vendedor-btn text-red-500 hover:text-red-700 text-xs mt-2">Eliminar Vendedor</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
        contentContainer.innerHTML = html;
        attachVendedoresEvents();
    }

    function attachVendedoresEvents() {
        document.getElementById('addVendedorBtn')?.addEventListener('click', () => {
            const nameInput = document.getElementById('newVendedorName');
            const name = nameInput.value.trim();
            if (name) {
                addVendedor(name);
                nameInput.value = '';
            } else {
                showModal("Faltan Datos", "Por favor, ingresa un nombre para el vendedor.", () => {}, false);
            }
        });

        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.target.dataset.id;
                const type = e.target.dataset.type;
                let amount = 0;
                let inputId;

                if (type === 'ENTREGA') {
                    inputId = `qty-entrega-${id}`;
                } else if (type === 'VENTA') {
                    inputId = `qty-venta-${id}`;
                } else if (type === 'PAGO') {
                    inputId = `monto-pago-${id}`;
                }

                amount = parseFloat(document.getElementById(inputId).value);

                if (isNaN(amount) || amount <= 0) {
                    showModal("Valor Inválido", "Por favor, ingresa una cantidad válida (> 0).", () => {}, false);
                    return;
                }
                
                showLoading();
                updateVendedor(id, type, amount).then(() => {
                    document.getElementById(inputId).value = ''; // Clear input on success
                    hideLoading();
                }).catch(() => {
                    hideLoading();
                });
            });
        });

        document.querySelectorAll('.delete-vendedor-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.target.dataset.id;
                const vendedor = vendedores.find(v => v.id === id);
                if (vendedor) {
                    showModal("Confirmar Eliminación", `¿Estás seguro de eliminar a ${vendedor.nombre}? Esto es irreversible.`, () => deleteVendedor(id));
                }
            });
        });
    }

    /**
     * @param {string} id
     */
    async function deleteVendedor(id) {
        if (!db || !isAuthReady) return;
        try {
            showLoading();
            await deleteDoc(doc(db, getCollectionPath('vendedores'), id));
            hideLoading();
        } catch (e) {
            console.error("Error deleting vendedor:", e);
            hideLoading();
            showModal("Error", "No se pudo eliminar el vendedor.", () => {}, false);
        }
    }

    // --- PUNTOS DE VENTA (POS) ENTITY Logic ---
    
    /**
     * @param {string} name
     */
    async function addPuntoDeVenta(name) {
        if (!db || !isAuthReady) return;
        try {
            showLoading();
            await addDoc(collection(db, getCollectionPath('puntos_de_venta')), {
                nombre: name,
                creado_en: Timestamp.now(),
            });
            hideLoading();
        } catch (e) {
            console.error("Error adding punto de venta:", e);
            hideLoading();
            showModal("Error", "No se pudo agregar el Punto de Venta.", () => {}, false);
        }
    }

    /**
     * @param {string} id
     */
    async function deletePuntoDeVenta(id) {
        if (!db || !isAuthReady) return;
        try {
            showLoading();
            await deleteDoc(doc(db, getCollectionPath('puntos_de_venta'), id));
            hideLoading();
        } catch (e) {
            console.error("Error deleting punto de venta:", e);
            hideLoading();
            showModal("Error", "No se pudo eliminar el Punto de Venta.", () => {}, false);
        }
    }

    // --- PUNTOS DE VENTA (POS) Movement Logic and Rendering ---

    /**
     * @param {string} nombre
     * @param {number} monto
     * @param {string} envia
     * @param {string} recibe
     */
    async function addMovimientoPOS(nombre, monto, envia, recibe) {
        if (!db || !isAuthReady) return;
        try {
            showLoading();
            await addDoc(collection(db, getCollectionPath('movimientos_pos')), {
                fecha_envio: Timestamp.now(),
                monto: monto,
                punto_venta_nombre: nombre,
                encargado_envia: envia, // Renamed key to reflect Encargado
                receptor_hub: recibe,
            });
            hideLoading();
        } catch (e) {
            console.error("Error adding movimiento POS:", e);
            hideLoading();
            showModal("Error", "No se pudo registrar el movimiento.", () => {}, false);
        }
    }

    function renderPuntosDeVenta() {
        const posNames = puntosDeVenta.map(p => p.nombre);

        const html = `
            <div class="space-y-6">
                
                <!-- Gestión de Entidades POS -->
                <div class="card bg-white p-4 rounded-xl">
                    <h2 class="text-xl font-semibold mb-3 text-gray-800">1. Gestión de Puntos de Venta (POS)</h2>
                    <div class="flex space-x-2 mb-4">
                        <input type="text" id="newPosName" placeholder="Nombre del Nuevo Punto de Venta" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <button id="addPosBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 text-sm">
                            Agregar POS
                        </button>
                    </div>
                    <div class="mt-4 border-t pt-4 border-gray-100">
                        <h3 class="font-medium text-gray-700 mb-2">POS Registrados (${puntosDeVenta.length})</h3>
                        <div class="flex flex-wrap gap-2">
                            ${puntosDeVenta.length === 0 ? '<span class="text-gray-500 text-sm">Aún no hay puntos de venta registrados.</span>' : ''}
                            ${puntosDeVenta.map(p => `
                                <div class="flex items-center bg-gray-100 rounded-full px-3 py-1 text-sm text-gray-800">
                                    ${p.nombre}
                                    <button data-id="${p.id}" class="delete-pos-entity-btn ml-2 text-red-400 hover:text-red-600">
                                        ${svgIcon('close', 'w-3 h-3')}
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Registro de Movimientos -->
                <div class="card bg-white p-4 rounded-xl">
                    <h2 class="text-xl font-semibold mb-3 text-gray-800">2. Registrar Envío de Dinero</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <select id="posNameSelect" class="p-2 border border-gray-300 rounded-lg col-span-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                            <option value="" disabled selected>Selecciona Punto de Venta</option>
                            ${posNames.map(name => `<option value="${name}">${name}</option>`).join('')}
                        </select>
                        ${posNames.length === 0 ? '<p class="text-xs text-red-500 col-span-2">¡Primero debes registrar un Punto de Venta arriba!</p>' : ''}

                        <input type="number" id="posMonto" placeholder="Monto Enviado ($)" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">

                        <input type="text" id="posQuienEnviaInput" placeholder="Nombre del Encargado (Quien Envía)" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">

                        <input type="text" id="posQuienRecibe" placeholder="¿Quién Recibe el dinero?" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm col-span-2">
                        
                        <button id="addMovimientoBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 text-sm col-span-2 mt-2" ${posNames.length === 0 ? 'disabled' : ''}>
                            Registrar Envío
                        </button>
                    </div>
                </div>

                <!-- Histórico de Movimientos -->
                <div class="space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800">3. Histórico de Movimientos (${movimientosPOS.length})</h2>
                    ${movimientosPOS.length === 0 ? '<p class="text-gray-500">No hay movimientos registrados.</p>' : ''}
                    <div class="bg-white rounded-xl divide-y divide-gray-100">
                    ${movimientosPOS.map(m => `
                        <div class="p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div class="mb-2 sm:mb-0">
                                <p class="font-bold text-lg text-indigo-700">$${m.monto.toFixed(2)}</p>
                                <p class="text-sm text-gray-700">Punto: <span class="font-medium">${m.punto_venta_nombre}</span></p>
                                <p class="text-xs text-gray-500">Envía (Encargado): ${m.encargado_envia} | Recibe: ${m.receptor_hub}</p>
                            </div>
                            <div class="text-right flex flex-col items-end space-y-1">
                                <p class="text-sm font-semibold text-gray-800">${new Date(m.fecha_envio.toDate()).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</p>
                                <p class="text-xs text-gray-500">${new Date(m.fecha_envio.toDate()).toLocaleDateString('es-ES', { dateStyle: 'short' })}</p>
                                <button data-id="${m.id}" class="delete-pos-movimiento-btn text-red-400 hover:text-red-600 text-xs mt-1">
                                    ${svgIcon('trash', 'w-4 h-4')}
                                </button>
                            </div>
                        </div>
                    `).join('')}
                    </div>
                </div>
            </div>
        `;
        contentContainer.innerHTML = html;
        attachPOSEvents();
    }

    function attachPOSEvents() {
        // Evento para agregar nueva entidad POS
        document.getElementById('addPosBtn')?.addEventListener('click', () => {
            const nameInput = document.getElementById('newPosName');
            const name = nameInput.value.trim();
            if (name) {
                addPuntoDeVenta(name);
                nameInput.value = '';
            } else {
                showModal("Faltan Datos", "Por favor, ingresa un nombre para el Punto de Venta.", () => {}, false);
            }
        });

        // Evento para eliminar entidad POS
        document.querySelectorAll('.delete-pos-entity-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                const pos = puntosDeVenta.find(p => p.id === id);
                if (pos) {
                     showModal("Confirmar Eliminación", `¿Estás seguro de eliminar el Punto de Venta "${pos.nombre}"? Esto no eliminará los movimientos históricos asociados.`, () => deletePuntoDeVenta(id));
                }
            });
        });

        // Evento para registrar nuevo movimiento POS
        document.getElementById('addMovimientoBtn')?.addEventListener('click', () => {
            const nombre = document.getElementById('posNameSelect').value;
            const monto = parseFloat(document.getElementById('posMonto').value);
            const envia = document.getElementById('posQuienEnviaInput').value.trim(); // Reads from the new input
            const recibe = document.getElementById('posQuienRecibe').value.trim();

            if (nombre && envia && recibe && !isNaN(monto) && monto > 0) {
                showLoading();
                addMovimientoPOS(nombre, monto, envia, recibe).then(() => {
                    document.getElementById('posMonto').value = '';
                    document.getElementById('posQuienRecibe').value = '';
                    document.getElementById('posQuienEnviaInput').value = '';
                    hideLoading();
                }).catch(() => hideLoading());
            } else {
                showModal("Faltan Datos", "Por favor, selecciona un POS, ingresa el nombre del encargado (quien envía), un receptor y un monto válido (> 0).", () => {}, false);
            }
        });

        // Evento para eliminar movimiento POS
        document.querySelectorAll('.delete-pos-movimiento-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                showModal("Confirmar Eliminación", `¿Estás seguro de eliminar este movimiento de dinero?`, () => deleteMovimientoPOS(id));
            });
        });
    }

    /**
     * @param {string} id
     */
    async function deleteMovimientoPOS(id) {
        if (!db || !isAuthReady) return;
        try {
            showLoading();
            await deleteDoc(doc(db, getCollectionPath('movimientos_pos'), id));
            hideLoading();
        } catch (e) {
            console.error("Error deleting movimiento POS:", e);
            hideLoading();
            showModal("Error", "No se pudo eliminar el movimiento.", () => {}, false);
        }
    }

    // --- RESUMEN (Summary) Logic and Rendering (NEW) ---

    function calculateGlobalMetrics() {
        const totalDeudaPendiente = vendedores.reduce((sum, v) => sum + Math.max(0, calculateVendedorStats(v).pendiente_de_pago), 0);
        const totalStockPendiente = vendedores.reduce((sum, v) => sum + v.entregado_qty - v.vendido_qty, 0);
        const totalDineroPOS = movimientosPOS.reduce((sum, m) => sum + m.monto, 0);
        const totalGastos = gastos.reduce((sum, g) => sum + g.monto, 0);
        const capitalNeto = totalDineroPOS - totalGastos;

        return {
            totalDeudaPendiente,
            totalStockPendiente,
            totalDineroPOS,
            totalGastos,
            capitalNeto
        };
    }

    function renderResumen() {
        const metrics = calculateGlobalMetrics();
        const resumenText = `
**RESUMEN GENERAL DEL NEGOCIO**
Fecha del Reporte: ${new Date().toLocaleDateString('es-ES')} a las ${new Date().toLocaleTimeString('es-ES')}

---
**DEUDAS DE VENDEDORES**
- Total Deuda Pendiente por Cobrar: $${metrics.totalDeudaPendiente.toFixed(2)}
- Total Stock Pendiente en la Calle (Qty): ${metrics.totalStockPendiente.toFixed(0)} unidades

---
**FLUJO DE CAJA**
- Dinero Total Recibido de POS: $${metrics.totalDineroPOS.toFixed(2)}
- Total Gastos Registrados: $${metrics.totalGastos.toFixed(2)}
- Capital Neto (POS - Gastos): $${metrics.capitalNeto.toFixed(2)}

---
**INFORMACIÓN ADICIONAL**
- Precio Unitario Actual: $${precioUnidad.toFixed(2)}
- ID de la Aplicación: ${appId}
        `.trim();

        const html = `
            <div class="space-y-6">
                <div class="card bg-white p-6 rounded-xl">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Resumen Financiero Rápido</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <div class="p-3 bg-red-50 rounded-lg">
                            <p class="text-sm font-medium text-red-600">DEUDA PENDIENTE POR COBRAR</p>
                            <p class="text-3xl font-extrabold text-red-700">$${metrics.totalDeudaPendiente.toFixed(2)}</p>
                        </div>
                        <div class="p-3 bg-green-50 rounded-lg">
                            <p class="text-sm font-medium text-green-600">CAPITAL NETO (POS - Gastos)</p>
                            <p class="text-3xl font-extrabold ${metrics.capitalNeto >= 0 ? 'text-green-700' : 'text-red-700'}">$${metrics.capitalNeto.toFixed(2)}</p>
                        </div>
                        <div class="p-3 bg-yellow-50 rounded-lg">
                            <p class="text-sm font-medium text-yellow-600">STOCK EN LA CALLE (Qty)</p>
                            <p class="text-3xl font-extrabold text-yellow-700">${metrics.totalStockPendiente.toFixed(0)}</p>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm font-medium text-blue-600">TOTAL DINERO RECIBIDO POS</p>
                            <p class="text-3xl font-extrabold text-blue-700">$${metrics.totalDineroPOS.toFixed(2)}</p>
                        </div>
                    </div>

                    <button id="copyResumenBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-300 text-sm flex items-center justify-center">
                        ${svgIcon('copy', 'w-5 h-5 mr-2')} Copiar Resumen para Compartir
                    </button>
                </div>

                <div class="card bg-gray-800 p-4 rounded-xl">
                    <h3 class="text-lg font-semibold text-white mb-2">Detalle del Texto a Compartir</h3>
                    <pre id="resumenTextDisplay" class="text-gray-200 text-xs whitespace-pre-wrap">${resumenText}</pre>
                </div>
            </div>
        `;
        contentContainer.innerHTML = html;
        attachResumenEvents(resumenText);
    }

    /**
     * @param {string} text
     */
    function copyToClipboard(text) {
        // Fallback for secure environments where navigator.clipboard might be blocked
        const tempTextarea = document.createElement('textarea');
        tempTextarea.value = text;
        tempTextarea.style.position = 'fixed';
        tempTextarea.style.opacity = '0';
        document.body.appendChild(tempTextarea);
        tempTextarea.select();
        try {
            document.execCommand('copy');
            showModal("Copiado", "¡El resumen ha sido copiado al portapapeles! Puedes pegarlo en tu chat o correo.", () => {}, false);
        } catch (err) {
            console.error('Error al copiar: ', err);
            showModal("Error", "No se pudo copiar el texto. Inténtalo manualmente desde el área de texto.", () => {}, false);
        }
        document.body.removeChild(tempTextarea);
    }

    /**
     * @param {string} resumenText
     */
    function attachResumenEvents(resumenText) {
        document.getElementById('copyResumenBtn')?.addEventListener('click', () => {
            copyToClipboard(resumenText);
        });
    }

    // --- GASTOS (Expenses) Logic and Rendering (Unchanged) ---

    /**
     * @param {number} monto
     * @param {string} concepto
     */
    async function addGasto(monto, concepto, categoria) {
        if (!db || !isAuthReady) return;
        try {
            showLoading();
            await addDoc(collection(db, getCollectionPath('gastos')), {
                fecha: Timestamp.now(),
                monto: monto,
                concepto: concepto,
                categoria: categoria,
                registrado_por: userId,
            });
            hideLoading();
        } catch (e) {
            console.error("Error adding gasto:", e);
            hideLoading();
            showModal("Error", "No se pudo registrar el gasto.", () => {}, false);
        }
    }

    function renderGastos() {
        const totalGastos = gastos.reduce((sum, g) => sum + g.monto, 0);
        const uniqueCategories = [...new Set(gastos.map(g => g.categoria))].sort();

        const html = `
            <div class="space-y-6">
                <div class="card bg-white p-4 rounded-xl">
                    <h2 class="text-xl font-semibold mb-3 text-gray-800">Registrar Nuevo Gasto</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="gastoMonto" placeholder="Monto del Gasto ($)" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <input type="text" id="gastoCategoria" placeholder="Categoría (Ej: Renta, Transporte)" list="gastoCategoriesList" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <datalist id="gastoCategoriesList">
                            ${uniqueCategories.map(cat => `<option value="${cat}">`).join('')}
                        </datalist>

                        <textarea id="gastoConcepto" placeholder="Concepto o Descripción del Gasto" rows="2" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm col-span-2"></textarea>
                        
                        <button id="addGastoBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 text-sm col-span-2 mt-2">
                            Registrar Gasto
                        </button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-gray-800">Histórico de Gastos (${gastos.length})</h2>
                        <p class="text-lg font-bold text-red-600">Total: $${totalGastos.toFixed(2)}</p>
                    </div>
                    ${gastos.length === 0 ? '<p class="text-gray-500">No hay gastos registrados.</p>' : ''}
                    <div class="bg-white rounded-xl divide-y divide-gray-100">
                    ${gastos.map(g => `
                        <div class="p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div class="mb-2 sm:mb-0">
                                <p class="font-bold text-lg text-red-600">-$${g.monto.toFixed(2)}</p>
                                <p class="text-sm text-gray-700"><span class="font-medium">${g.concepto}</span></p>
                                <p class="text-xs text-gray-500">Categoría: ${g.categoria}</p>
                            </div>
                            <div class="text-right flex items-center space-x-3">
                                <p class="text-sm text-gray-500">${new Date(g.fecha.toDate()).toLocaleString('es-ES', { dateStyle: 'short' })}</p>
                                <button data-id="${g.id}" class="delete-gasto-btn text-red-400 hover:text-red-600 text-xs">
                                    ${svgIcon('trash', 'w-4 h-4')}
                                </button>
                            </div>
                        </div>
                    `).join('')}
                    </div>
                </div>
            </div>
        `;
        contentContainer.innerHTML = html;
        attachGastosEvents();
    }

    function attachGastosEvents() {
        document.getElementById('addGastoBtn')?.addEventListener('click', () => {
            const monto = parseFloat(document.getElementById('gastoMonto').value);
            const concepto = document.getElementById('gastoConcepto').value.trim();
            const categoria = document.getElementById('gastoCategoria').value.trim() || 'Sin Categoría';

            if (!isNaN(monto) && monto > 0 && concepto) {
                showLoading();
                addGasto(monto, concepto, categoria).then(() => {
                    document.getElementById('gastoMonto').value = '';
                    document.getElementById('gastoConcepto').value = '';
                    document.getElementById('gastoCategoria').value = '';
                    hideLoading();
                }).catch(() => hideLoading());
            } else {
                showModal("Faltan Datos", "Por favor, ingresa un monto válido (> 0) y el concepto del gasto.", () => {}, false);
            }
        });

        document.querySelectorAll('.delete-gasto-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                showModal("Confirmar Eliminación", `¿Estás seguro de eliminar este gasto?`, () => deleteGasto(id));
            });
        });
    }

    /**
     * @param {string} id
     */
    async function deleteGasto(id) {
        if (!db || !isAuthReady) return;
        try {
            showLoading();
            await deleteDoc(doc(db, getCollectionPath('gastos'), id));
            hideLoading();
        } catch (e) {
            console.error("Error deleting gasto:", e);
            hideLoading();
            showModal("Error", "No se pudo eliminar el gasto.", () => {}, false);
        }
    }

    // --- CONFIGURACIÓN (Configuration) Logic and Rendering (Unchanged) ---

    /**
     * @param {number} newPrice
     */
    async function updatePrecioUnidad(newPrice) {
        if (!db || !isAuthReady) return;
        try {
            showLoading();
            await setDoc(doc(db, getCollectionPath('config'), 'global'), { precioUnidad: newPrice }, { merge: true });
            precioUnidad = newPrice;
            hideLoading();
            showModal("Éxito", `El precio por unidad se ha actualizado a $${newPrice.toFixed(2)}. Las deudas de los vendedores se recalcularán.`, () => {}, false);
        } catch (e) {
            console.error("Error updating config:", e);
            hideLoading();
            showModal("Error", "No se pudo actualizar la configuración.", () => {}, false);
        }
    }


    function renderConfiguracion() {
        const html = `
            <div class="space-y-6">
                <div class="card bg-white p-6 rounded-xl">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Configuración General</h2>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2" for="unitPrice">Precio por Unidad de Producto</label>
                        <p class="text-sm text-gray-500 mb-3">Este valor se usa para calcular la deuda monetaria de los vendedores (Cantidad Vendida * Precio Unidad).</p>
                        <div class="flex space-x-2">
                            <input type="number" id="unitPriceInput" value="${precioUnidad.toFixed(2)}" step="0.01" min="1" 
                                class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                            <button id="saveUnitPriceBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 text-sm">
                                Guardar Precio
                            </button>
                        </div>
                    </div>

                    <div class="mt-8 pt-4 border-t border-gray-200">
                        <h3 class="text-xl font-semibold mb-2 text-gray-800">ID del Sistema</h3>
                        <p class="text-sm text-gray-600 break-all">ID de la Aplicación (Para compartir el mismo set de datos con otros usuarios):</p>
                        <code class="block bg-gray-100 p-2 rounded-lg text-xs mt-1 text-gray-800">${appId}</code>
                        <p class="text-sm text-gray-600 mt-4 break-all">ID de Usuario (Su identificador actual):</p>
                        <code class="block bg-gray-100 p-2 rounded-lg text-xs mt-1 text-gray-800">${userId}</code>
                    </div>
                </div>
            </div>
        `;
        contentContainer.innerHTML = html;
        attachConfigEvents();
    }

    function attachConfigEvents() {
        document.getElementById('saveUnitPriceBtn')?.addEventListener('click', () => {
            const input = document.getElementById('unitPriceInput');
            const newPrice = parseFloat(input.value);

            if (!isNaN(newPrice) && newPrice > 0) {
                showModal("Confirmar Cambio", `¿Seguro que deseas cambiar el precio por unidad a $${newPrice.toFixed(2)}?`, () => updatePrecioUnidad(newPrice));
            } else {
                showModal("Valor Inválido", "Por favor, ingresa un precio válido (> 0).", () => {}, false);
            }
        });
    }

    // --- General Event Listeners and Initialization ---

    tabButtons.forEach(button => {
        button.addEventListener('click', (e) => renderTab(e.target.dataset.tab));
    });

    /**
     * @param {string} iconName
     * @param {string} classes
     */
    function svgIcon(iconName, classes) {
        // Simple SVG Icons for minor elements (trash can, close, copy)
        if (iconName === 'trash') {
            return `<svg class="${classes}" fill="none" viewBox="0 0 24 24" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>`;
        }
        if (iconName === 'close') {
            return `<svg class="${classes}" fill="none" viewBox="0 0 24 24" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>`;
        }
        if (iconName === 'copy') {
            return `<svg class="${classes}" fill="none" viewBox="0 0 24 24" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v4a1 1 0 001 1h5m-5-4h4a1 1 0 011 1v7m-4-7v7a1 1 0 01-1 1H3a1 1 0 01-1-1V9a1 1 0 011-1h7M17 9l4 4m0 0l-4 4m4-4H9"/></svg>`;
        }
        return '';
    }

    // Ensure initial tab is rendered when everything is set up by checking isAuthReady in onAuthStateChanged
</script>

</body>
</html>

