<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Ventas y Finanzas</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .tab-button.active {
            border-bottom-width: 3px;
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            font-weight: 600;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body>
<div id="app" class="min-h-screen bg-gray-50 flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">Control de Negocio</h1>
            <div class="text-xs text-gray-500 rounded-full bg-gray-100 px-3 py-1 truncate" id="userIdDisplay">Cargando...</div>
        </div>
        <!-- Tabs -->
        <nav class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 flex space-x-4 border-b border-gray-200">
            <button class="tab-button py-3 px-2 text-sm text-gray-600 hover:text-blue-500 active" data-tab="vendedores">Vendedores</button>
            <button class="tab-button py-3 px-2 text-sm text-gray-600 hover:text-blue-500" data-tab="pos">Puntos de Venta</button>
            <button class="tab-button py-3 px-2 text-sm text-gray-600 hover:text-blue-500" data-tab="gastos">Gastos</button>
            <button class="tab-button py-3 px-2 text-sm text-gray-600 hover:text-blue-500" data-tab="resumen">Resumen</button>
            <button class="tab-button py-3 px-2 text-sm text-gray-600 hover:text-blue-500" data-tab="config">Configuración</button>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow max-w-4xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6">
        <div id="content-container">
            <!-- Content will be injected here -->
        </div>
    </main>

    <!-- Custom Modal for Alerts/Confirmation -->
    <div id="custom-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform scale-95 transition-all">
            <h3 class="text-lg font-semibold text-gray-900 mb-4" id="modal-title">Atención</h3>
            <p class="text-sm text-gray-600 mb-6" id="modal-message"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300 transition">Cancelar</button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-100 bg-opacity-70 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
            <p class="mt-4 text-gray-600">Cargando datos...</p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, deleteDoc, addDoc, Timestamp, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Variables Globales ---
    const TABS = { VENDEDORES: 'vendedores', POS: 'pos', GASTOS: 'gastos', RESUMEN: 'resumen', CONFIG: 'config' };
    let currentTab = TABS.VENDEDORES;
    let vendedores = [];
    let puntosDeVenta = [];
    let movimientosPOS = [];
    let gastos = [];
    let precioUnidad = 50;
    let userId = null;
    let db, auth;
    let isAuthReady = false;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- LocalStorage Helpers ---
    function saveVendedoresToLocal() {
        localStorage.setItem('vendedores', JSON.stringify(vendedores));
    }
    function loadVendedoresFromLocal() {
        const data = localStorage.getItem('vendedores');
        vendedores = data ? JSON.parse(data) : [];
    }
    function savePuntosDeVentaToLocal() {
        localStorage.setItem('puntosDeVenta', JSON.stringify(puntosDeVenta));
    }
    function loadPuntosDeVentaFromLocal() {
        const data = localStorage.getItem('puntosDeVenta');
        puntosDeVenta = data ? JSON.parse(data) : [];
    }

    // --- DOM Elements ---
    const contentContainer = document.getElementById('content-container');
    const tabButtons = document.querySelectorAll('.tab-button');
    const loadingOverlay = document.getElementById('loading-overlay');
    const userIdDisplay = document.getElementById('userIdDisplay');

    // --- Firebase Initialization and Auth ---
    if (firebaseConfig) {
        setLogLevel('debug');
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        const setupAuth = async () => {
            try {
                await setPersistence(auth, browserSessionPersistence);
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }
        };

        onAuthStateChanged(auth, (user) => {
            userId = user ? user.uid : 'Anonimo-' + crypto.randomUUID();
            userIdDisplay.textContent = `ID Usuario: ${userId.substring(0, 10)}...`;
            isAuthReady = true;
            hideLoading();
            renderTab(currentTab);
            setupFirestoreListeners();
        });

        setupAuth();
    } else {
        // Modo Simulación: Cargar vendedores y puntos de venta de localStorage al inicio
        userIdDisplay.textContent = 'Modo Simulación';
        isAuthReady = true;
        hideLoading();
        loadVendedoresFromLocal();
        loadPuntosDeVentaFromLocal();
        renderTab(currentTab);
    }

    // --- Utility Functions ---
    function showLoading() { loadingOverlay.classList.remove('opacity-0', 'pointer-events-none'); }
    function hideLoading() { loadingOverlay.classList.add('opacity-0', 'pointer-events-none'); }

    // --- TAB RENDERING (solo muestra pestañas, no cambia lógica) ---
    function renderTab(tabName) {
        currentTab = tabName;
        tabButtons.forEach(button => {
            button.classList.remove('active');
            if (button.dataset.tab === tabName) {
                button.classList.add('active');
            }
        });
        switch (tabName) {
            case TABS.VENDEDORES:
                renderVendedores();
                break;
            case TABS.POS:
                renderPuntosDeVenta();
                break;
            case TABS.GASTOS:
                renderGastos();
                break;
            case TABS.RESUMEN:
                renderResumen();
                break;
            case TABS.CONFIG:
                renderConfiguracion();
                break;
        }
    }

    // --- ADAPTACIONES PARA LOCALSTORAGE EN MODO SIMULACIÓN ---

    // Agrega vendedor
    async function addVendedor(name) {
        if (!db && !firebaseConfig) { // Modo localStorage
            const newVendedor = {
                id: crypto.randomUUID(),
                nombre: name,
                entregado_qty: 0,
                vendido_qty: 0,
                pagado: 0
            };
            vendedores.push(newVendedor);
            saveVendedoresToLocal();
            renderVendedores();
            return;
        }
        // Tu código original Firebase aquí...
        // ...
    }

    // Elimina vendedor
    async function deleteVendedor(id) {
        if (!db && !firebaseConfig) {
            vendedores = vendedores.filter(v => v.id !== id);
            saveVendedoresToLocal();
            renderVendedores();
            return;
        }
        // Tu código original Firebase aquí...
        // ...
    }

    // Agrega punto de venta
    async function addPuntoDeVenta(name) {
        if (!db && !firebaseConfig) {
            const newPunto = {
                id: crypto.randomUUID(),
                nombre: name,
                creado_en: new Date().toISOString()
            };
            puntosDeVenta.push(newPunto);
            savePuntosDeVentaToLocal();
            renderPuntosDeVenta();
            return;
        }
        // Tu código original Firebase aquí...
        // ...
    }

    // Elimina punto de venta
    async function deletePuntoDeVenta(id) {
        if (!db && !firebaseConfig) {
            puntosDeVenta = puntosDeVenta.filter(p => p.id !== id);
            savePuntosDeVentaToLocal();
            renderPuntosDeVenta();
            return;
        }
        // Tu código original Firebase aquí...
        // ...
    }

    // Cuando muestres la pestaña de vendedores, carga del localStorage si está en modo simulación
    function renderVendedores() {
        if (!firebaseConfig) loadVendedoresFromLocal();
        // ... tu código original de renderizado ...
        // Aquí pega el resto de tu función renderVendedores original
    }

    // Cuando muestres la pestaña de puntos de venta, carga del localStorage si está en modo simulación
    function renderPuntosDeVenta() {
        if (!firebaseConfig) loadPuntosDeVentaFromLocal();
        // ... tu código original de renderizado ...
        // Aquí pega el resto de tu función renderPuntosDeVenta original
    }

    // El resto de tu código JS sigue igual...
    // (aquí va el resto de tu lógica para gastos, resumen, configuración, eventos, etc.)
</script>
</body>
</html>
