<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestor de Ventas</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { margin: 4px 0; padding: 6px; }
    #ventas-list li { margin: 8px 0; }
  </style>
</head>
<body>
  <h1>Gestor de Ventas (local)</h1>

  <section>
    <h2>Registrar venta</h2>
    <form id="venta-form">
      <div>
        <input id="cliente" placeholder="Cliente" required />
      </div>
      <div>
        <input id="producto" placeholder="Producto" required />
      </div>
      <div>
        <input id="cantidad" type="number" placeholder="Cantidad" value="1" min="1" />
      </div>
      <div>
        <input id="total" type="number" step="0.01" placeholder="Total" value="0" />
      </div>
      <div>
        <button type="submit">Agregar</button>
        <button type="button" id="export-btn">Exportar JSON</button>
        <button type="button" id="import-btn">Importar JSON</button>
        <input id="import-file" type="file" accept="application/json" style="display:none" />
      </div>
    </form>
  </section>

  <section>
    <h2>Ventas</h2>
    <ul id="ventas-list"></ul>
    <div>
      <button id="clear-all">Eliminar todo</button>
    </div>
  </section>

  <script>
  /* Persistencia en localStorage para Gestor-de-ventas */
  const STORAGE_KEY = 'gestor_ventas_v1';

  // Cargar datos desde localStorage (devuelve array)
  function loadVentas() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      return JSON.parse(raw);
    } catch (e) {
      console.error('Error al leer localStorage:', e);
      return [];
    }
  }

  // Guardar array de ventas en localStorage
  function saveVentas(ventas) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(ventas));
    } catch (e) {
      console.error('Error al guardar en localStorage:', e);
    }
  }

  // Agregar una venta nueva
  function addVenta(venta) {
    const ventas = loadVentas();
    ventas.push(venta);
    saveVentas(ventas);
    renderVentas();
  }

  // Eliminar una venta por id
  function removeVenta(id) {
    let ventas = loadVentas();
    ventas = ventas.filter(v => v.id !== id);
    saveVentas(ventas);
    renderVentas();
  }

  // Eliminar todo
  function clearAll() {
    if (!confirm('Eliminar todas las ventas?')) return;
    localStorage.removeItem(STORAGE_KEY);
    renderVentas();
  }

  // Renderizar la lista en el DOM
  function renderVentas() {
    const ventas = loadVentas();
    const listEl = document.getElementById('ventas-list');
    if (!listEl) return;
    listEl.innerHTML = '';

    if (ventas.length === 0) {
      listEl.innerHTML = '<li>No hay ventas registradas.</li>';
      return;
    }

    ventas.forEach(v => {
      const li = document.createElement('li');
      li.textContent = `${v.fecha} — ${v.cliente}: ${v.producto} x${v.cantidad} => $${v.total}`;
      // Botón eliminar
      const btn = document.createElement('button');
      btn.textContent = 'Eliminar';
      btn.style.marginLeft = '10px';
      btn.addEventListener('click', () => {
        if (confirm('Eliminar esta venta?')) removeVenta(v.id);
      });
      li.appendChild(btn);
      listEl.appendChild(li);
    });
  }

  // Exportar JSON
  function exportJSON() {
    const ventas = loadVentas();
    const dataStr = JSON.stringify(ventas, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'gestor_ventas_export.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // Importar JSON (archivo)
  function importJSONFile(file) {
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const imported = JSON.parse(reader.result);
        if (!Array.isArray(imported)) throw new Error('Formato inválido: se esperaba un array');
        // Opcional: validar elementos mínimamente
        const ventas = loadVentas();
        const merged = ventas.concat(imported.map(item => ({
          id: item.id || Date.now().toString() + Math.random().toString(36).slice(2),
          cliente: item.cliente || '',
          producto: item.producto || '',
          cantidad: item.cantidad || 1,
          total: item.total || 0,
          fecha: item.fecha || new Date().toLocaleString()
        })));
        saveVentas(merged);
        renderVentas();
        alert('Importación completada.');
      } catch (e) {
        alert('Error al importar JSON: ' + e.message);
      }
    };
    reader.onerror = () => alert('No se pudo leer el archivo');
    reader.readAsText(file);
  }

  // Hook para formulario
  function setupForm() {
    const form = document.getElementById('venta-form');
    if (!form) return;

    form.addEventListener('submit', e => {
      e.preventDefault();
      const cliente = document.getElementById('cliente').value.trim();
      const producto = document.getElementById('producto').value.trim();
      const cantidad = parseInt(document.getElementById('cantidad').value, 10) || 1;
      const total = parseFloat(document.getElementById('total').value) || 0;
      const fecha = new Date().toLocaleString();

      if (!cliente || !producto) {
        alert('Completa los campos requeridos.');
        return;
      }

      const venta = {
        id: Date.now().toString() + Math.random().toString(36).slice(2),
        cliente, producto, cantidad, total, fecha
      };

      addVenta(venta);
      form.reset();
      document.getElementById('cliente').focus();
    });

    document.getElementById('export-btn').addEventListener('click', exportJSON);

    const importBtn = document.getElementById('import-btn');
    const importFile = document.getElementById('import-file');
    importBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) importJSONFile(file);
      importFile.value = '';
    });

    document.getElementById('clear-all').addEventListener('click', clearAll);
  }

  // Inicialización
  window.addEventListener('DOMContentLoaded', () => {
    setupForm();
    renderVentas();
  });
  </script>
</body>
</html>
